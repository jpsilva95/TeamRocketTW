(function(){'use strict';
/* Mild obfuscation: short names, minified layout. Behavior preserved. */
function a(){if(document.getElementById('trDailiesBtn'))return;const q=document.querySelector('.questlog, #questlog_new, [id*="questlog"]');if(q){const c=document.createElement('div');c.style.cssText='margin-top: 5px; text-align: center;';const b=document.createElement('button');b.id='trDailiesBtn';b.innerHTML='<img src="https://i.ibb.co/RptK4TP5/teamrocketlogo.gif" style="width: 30px; height: 30px;">';b.title='Daily Stats to Discord';b.style.cssText='width: 40px; height: 40px; background: transparent; border: none; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; padding: 0;';b.onclick=function(e){e.preventDefault();B();};c.appendChild(b);q.appendChild(c);}else{const h=document.querySelector('#header_info');if(h){const n=document.createElement('a');n.id='trDailiesBtn';n.href='#';n.innerHTML='<img src="https://i.ibb.co/RptK4TP5/teamrocketlogo.gif" style="width: 20px; height: 20px; vertical-align: middle;">';n.title='Daily Stats';n.style.cssText='margin-left: 10px; padding: 5px; background: transparent; border: none; text-decoration: none; display: inline-block;';n.onclick=function(e){e.preventDefault();B();};h.appendChild(n);}}}
function B(){/* open popup */const overlay=document.createElement('div');overlay.style.cssText='position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;';const popup=document.createElement('div');popup.style.cssText='background: #2C2F33; color: #DCDDDE; padding: 25px; border-radius: 8px; width: 550px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);';popup.innerHTML=`<h2 style="margin-top: 0; color: #5865F2;">üìä Send Daily Stats to Discord</h2>
<div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Discord Webhook URL:</label>
    <input type="text" id="webhookUrl" placeholder="https://discord.com/api/webhooks/..."
        style="width: 100%; padding: 8px; border: 1px solid #40444B; background: #40444B; color: #DCDDDE; border-radius: 4px; box-sizing: border-box;">
</div>
<div style="margin-bottom: 15px;">
    <label style="display: block; margin-bottom: 5px;">
        <input type="checkbox" id="autoSendEnabled" style="margin-right: 5px;">
        <strong>Auto-send daily at:</strong>
    </label>
    <input type="time" id="autoSendTime" value="23:00" disabled
        style="width: 100%; padding: 8px; border: 1px solid #40444B; background: #40444B; color: #DCDDDE; border-radius: 4px; box-sizing: border-box;">
    <p style="font-size: 12px; color: #B9BBBE; margin: 5px 0 0 0;">Leave the game open for auto-send to work</p>
</div>
<div id="statsPreview" style="background: #40444B; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
    <p style="margin: 5px 0;"><strong>Gathering stats...</strong></p>
</div>
<div style="display: flex; gap: 10px;">
    <button id="sendBtn" style="flex: 1; padding: 10px; background: #5865F2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
        Send to Discord
    </button>
    <button id="closeBtn" style="flex: 1; padding: 10px; background: #ED4245; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
        Close
    </button>
</div>
<div id="statusMsg" style="margin-top: 15px; text-align: center; font-size: 14px;"></div>`;overlay.appendChild(popup);document.body.appendChild(overlay);
const savedWebhook=localStorage.getItem('tw_discord_webhook'),savedAuto=localStorage.getItem('tw_auto_send_enabled')==='true',savedTime=localStorage.getItem('tw_auto_send_time')||'23:00';if(savedWebhook)document.getElementById('webhookUrl').value=savedWebhook;const ch=document.getElementById('autoSendEnabled'),tm=document.getElementById('autoSendTime');ch.checked=savedAuto;tm.value=savedTime;tm.disabled=!ch.checked;ch.onchange=function(){tm.disabled=!ch.checked;localStorage.setItem('tw_auto_send_enabled',ch.checked);if(ch.checked){localStorage.setItem('tw_auto_send_time',tm.value);g();}};tm.onchange=function(){localStorage.setItem('tw_auto_send_time',tm.value);if(ch.checked)g();};
const preview=document.getElementById('statsPreview');preview.innerHTML='<p style="margin: 5px 0;"><strong>Loading stats...</strong></p>';c().then(function(s){let th='';if(Object.keys(s.troopsHome).length>0){th='<p style="margin: 10px 0 5px 0; border-top: 1px solid #2C2F33; padding-top: 10px;"><strong>‚öîÔ∏è Total Troops at Home:</strong></p>';for(let [u,d]of Object.entries(s.troopsHome)){const cnt=typeof d.count==='number'?d.count:parseInt((d.count||'0').toString().replace(/\D/g,''))||0;if(cnt===0)continue;const ic=d.icon?`<img src="${d.icon}" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">` : '';th+=`<p style="margin: 2px 0; padding-left: 20px; font-size: 13px;">${ic}${u}: ${d.count}</p>`;}}let ts='';if(Object.keys(s.troopsScavenging).length>0){ts='<p style="margin: 10px 0 5px 0; border-top: 1px solid #2C2F33; padding-top: 10px;"><strong>üîç Total Troops Scavenging:</strong></p>';for(let [u,d]of Object.entries(s.troopsScavenging)){const cnt=typeof d.count==='number'?d.count:parseInt((d.count||'0').toString().replace(/\D/g,''))||0;if(cnt===0)continue;const ic=d.icon?`<img src="${d.icon}" style="width: 18px; height: 18px; vertical-align: middle; margin-right: 4px;">` : '';ts+=`<p style="margin: 2px 0; padding-left: 20px; font-size: 13px;">${ic}${u}: ${d.count}</p>`;}}if(s.playerName&&s.playerName!=='Unknown'){const w=document.getElementById('webhookUrl').value.trim();if(w){const h=w.split('/').pop();const k=`tw_player_name_${s.world}_${h}`;localStorage.setItem(k,s.playerName);}}let manual='';if(s.playerName==='Unknown'){manual=`<div style="margin: 10px 0; padding: 10px; background: #ED4245; border-radius: 4px;"><p style="margin: 0 0 5px 0; font-size: 12px; color: white;"><strong>‚ö†Ô∏è Player name not detected</strong></p><input type="text" id="manualPlayerName" placeholder="Enter your player name" style="width: 100%; padding: 6px; border: 1px solid #40444B; background: #40444B; color: #DCDDDE; border-radius: 4px; box-sizing: border-box; font-size: 13px;"></div>`;}preview.innerHTML=`<p style="margin: 5px 0;"><strong>üåç World:</strong> ${s.world}</p><p style="margin: 5px 0;"><strong>üë§ Player:</strong> ${s.playerName}</p>${manual}<p style="margin: 5px 0;"><strong>üåæ Daily Farm Total:</strong> ${s.farmTotal}</p><p style="margin: 5px 0;"><strong>üì¶ Daily Resources Total:</strong> ${s.gatherTotal}</p><p style="margin: 10px 0 5px 0; border-top: 1px solid #2C2F33; padding-top: 10px;"><strong>üí∞ Grand Total:</strong> ${s.grandTotal}</p>${th}${ts}`;}).catch(function(err){preview.innerHTML='<p style="margin: 5px 0; color: #ED4245;"><strong>Error loading stats. Please try again.</strong></p>';console.error('Error gathering stats:',err);});
document.getElementById('closeBtn').onclick=function(){document.body.removeChild(overlay);};
document.getElementById('sendBtn').onclick=async function(){const w=document.getElementById('webhookUrl').value.trim();const sm=document.getElementById('statusMsg');if(!w){sm.innerHTML='<span style="color: #ED4245;">‚ùå Please enter a webhook URL</span>';return;}localStorage.setItem('tw_discord_webhook',w);sm.innerHTML='<span style="color: #FEE75C;">‚è≥ Sending...</span>';const s=await c();const mn=document.getElementById('manualPlayerName');if(mn&&mn.value.trim()){s.playerName=mn.value.trim();const h=w.split('/').pop();const k=`tw_player_name_${s.world}_${h}`;localStorage.setItem(k,s.playerName);}f(w,s,sm);overlay.onclick=function(e){if(e.target===overlay)document.body.removeChild(overlay);};}
}
function d(str){if(!str)return 0;const cleaned=str.replace(/\s/g,'').replace(/\./g,'').replace(/[^\d]/g,'');return parseInt(cleaned)||0;}
function e(n){return n.toLocaleString('pt-PT');}
async function c(){const stats={farmResources:{wood:'N/A',clay:'N/A',iron:'N/A'},gatherResources:{wood:'N/A',clay:'N/A',iron:'N/A'},farmTotal:'N/A',gatherTotal:'N/A',grandTotal:'N/A',playerName:'Unknown',troopsHome:{},troopsScavenging:{},world:'Unknown'};try{const base=window.location.origin+window.location.pathname;const params=new URLSearchParams(window.location.search);const wm=window.location.hostname.match(/^(\w+)\./);stats.world=wm?wm[1].toUpperCase():'Unknown';try{const p=await fetch(`${base}?${params.toString()}&screen=info_player`);const pt=await p.text();const pd=new DOMParser().parseFromString(pt,'text/html');const sel=pd.querySelector('td.selected a[href*="screen=info_player"]');if(sel)stats.playerName=sel.textContent.trim();if(stats.playerName==='Unknown'||!stats.playerName){const mm=pd.querySelector('table.vis.modemenu td.selected a');if(mm)stats.playerName=mm.textContent.trim();} }catch(err){} // continue gracefully
// try other DOM fallbacks on current page
if((stats.playerName==='Unknown'||!stats.playerName)){const mp=document.querySelector('#menu_row2 a[href*="screen=info_player"]:not([href*="id="])');if(mp)stats.playerName=mp.textContent.trim();}
if((stats.playerName==='Unknown'||!stats.playerName)){const mr=document.querySelector('#menu_row2');if(mr){const all=mr.querySelectorAll('a[href*="screen=info_player"]:not([href*="id="])');if(all.length>0)stats.playerName=all[0].textContent.trim();}}
// loot stats
try{const loot=await fetch(`${base}?${params.toString()}&screen=ranking&mode=in_a_day&type=loot_res`);const lt=await loot.text();const ldoc=new DOMParser().parseFromString(lt,'text/html');const myRes=ldoc.querySelector('#content_value');if(myRes){const rt=myRes.textContent;const rm=rt.match(/O\\s+meu\\s+resultado\\s+de\\s+hoje:\\s*([\\d\\s\\.]+)/i);if(rm){const ft=d(rm[1]);stats.farmTotal=e(ft);const lr=ldoc.querySelector('#in_a_day_ranking_table tr.lit, #in_a_day_ranking_table tr.lit-item');if(lr){const cells=lr.querySelectorAll('td');if(cells.length>=5){stats.farmResources.wood=e(d(cells[2]?.textContent));stats.farmResources.clay=e(d(cells[3]?.textContent));stats.farmResources.iron=e(d(cells[4]?.textContent));}}}}}catch(err){console.error('loot err',err);}
// gather stats
try{const sc=await fetch(`${base}?${params.toString()}&screen=ranking&mode=in_a_day&type=scavenge`);const st=await sc.text();const sdoc=new DOMParser().parseFromString(st,'text/html');const mg=sdoc.querySelector('#content_value');if(mg){const gt=mg.textContent;const gm=gt.match(/O\\s+meu\\s+resultado\\s+de\\s+hoje:\\s*([\\d\\s\\.]+)/i);if(gm){const gsum=d(gm[1]);stats.gatherTotal=e(gsum);const sr=sdoc.querySelector('#in_a_day_ranking_table tr.lit, #in_a_day_ranking_table tr.lit-item');if(sr){const cells=sr.querySelectorAll('td');if(cells.length>=5){stats.gatherResources.wood=e(d(cells[2]?.textContent));stats.gatherResources.clay=e(d(cells[3]?.textContent));stats.gatherResources.iron=e(d(cells[4]?.textContent));}}}}}catch(err){console.error('scavenge err',err);}
// grand total
if(stats.gatherTotal!=='N/A'&&stats.farmTotal!=='N/A'){const sum=d(stats.gatherTotal)+d(stats.farmTotal);stats.grandTotal=e(sum);}
// troops via scavenge_mass pages
const cdn='https://dspt.innogamescdn.com/asset/caf5a096/graphic/unit/';const unitMap={'spear':'Spear','sword':'Sword','axe':'Axe','archer':'Archer','spy':'Spy','light':'Light Cav','marcher':'Mounted Archer','heavy':'Heavy Cav','ram':'Ram','catapult':'Catapult','knight':'Paladin','snob':'Noble'};
try{let page=0,done=false,found=false;while(!done){const url=`${base}?${params.toString()}&screen=place&mode=scavenge_mass&page=${page}`;const r=await fetch(url);const tx=await r.text();const m=tx.match(/ScavengeMassScreen[\\s\\S]*?(,\\n *\\[.*?\\}{0,3}\\],\\n)/);if(!m||m.length<=1)break;let js=m[1];js=js.substring(js.indexOf('['));js=js.substring(0,js.length-2);const arr=JSON.parse(js);if(arr.length===0){done=true;break;}arr.forEach(function(v){if(!found&&v.player_name){stats.playerName=v.player_name;found=true;}if(v.unit_counts_home){Object.entries(v.unit_counts_home).forEach(function([u,cnt]){if(u!=='militia'&&unitMap[u]){const nm=unitMap[u];if(!stats.troopsHome[nm])stats.troopsHome[nm]={count:0,icon:cdn+'unit_'+u+'.png'};stats.troopsHome[nm].count+=cnt;}});}if(v.options){Object.values(v.options).forEach(function(opt){if(opt.scavenging_squad&&opt.scavenging_squad.unit_counts){Object.entries(opt.scavenging_squad.unit_counts).forEach(function([u,cnt]){if(u!=='militia'&&unitMap[u]){const nm=unitMap[u];if(!stats.troopsScavenging[nm])stats.troopsScavenging[nm]={count:0,icon:cdn+'unit_'+u+'.png'};stats.troopsScavenging[nm].count+=cnt;}});}}});});page++;await new Promise(function(res){setTimeout(res,200);});}
// fallback for player name
if((stats.playerName==='Unknown'||!stats.playerName)){if(typeof game_data!=='undefined'&&game_data.player&&game_data.player.name)stats.playerName=game_data.player.name;else{try{const pr=await fetch(`${base}?${params.toString()}&screen=info_player`);const ptxt=await pr.text();const pdoc=new DOMParser().parseFromString(ptxt,'text/html');const stp=pdoc.querySelector('td.selected a[href*="screen=info_player"]');if(stp)stats.playerName=stp.textContent.trim();if(stats.playerName==='Unknown'||!stats.playerName){const mm2=pdoc.querySelector('table.vis.modemenu td.selected a');if(mm2)stats.playerName=mm2.textContent.trim();}}catch(e){console.error('profile fallback',e);}}
for(const u in stats.troopsHome)stats.troopsHome[u].count=e(stats.troopsHome[u].count);for(const u in stats.troopsScavenging)stats.troopsScavenging[u].count=e(stats.troopsScavenging[u].count);
}catch(ex){console.log('Error gathering stats:',ex);}return stats;}
function f(webhook,stats,statusMsg){const fields=[{name:'üë§ Player',value:stats.playerName,inline:false},{name:'üåç World',value:stats.world,inline:false},{name:'üåæ Daily Farm Total',value:stats.farmTotal,inline:true},{name:'üì¶ Daily Resources Total',value:stats.gatherTotal,inline:true},{name:'üí∞ Grand Total',value:stats.grandTotal,inline:false}];
if(Object.keys(stats.troopsHome).length>0){let t='';for(const [u,d]of Object.entries(stats.troopsHome)){const cnt=typeof d.count==='string'?parseInt(d.count.toString().replace(/\D/g,''))||0:d.count;if(cnt===0)continue;t+=`${u}: ${d.count}\n`; }if(t.trim().length>0)fields.push({name:'‚öîÔ∏è Total Troops at Home',value:t.trim(),inline:false});}
if(Object.keys(stats.troopsScavenging).length>0){let t='';for(const [u,d]of Object.entries(stats.troopsScavenging)){const cnt=typeof d.count==='string'?parseInt(d.count.toString().replace(/\D/g,''))||0:d.count;if(cnt===0)continue;t+=`${u}: ${d.count}\n`;}if(t.trim().length>0)fields.push({name:'üîç Total Troops Scavenging',value:t.trim(),inline:false});}
const embed={title:'üìä Tribal Wars Daily Report',color:5814783,fields:fields,timestamp:new Date().toISOString(),footer:{text:'TeamRocket Bot'}};const payload=JSON.stringify({embeds:[embed]});
if(typeof GM_xmlhttpRequest!=='undefined'){GM_xmlhttpRequest({method:'POST',url:webhook,headers:{'Content-Type':'application/json'},data:payload,onload:function(resp){if(resp.status===204){if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #57F287;">‚úÖ Successfully sent to Discord!</span>';else if(typeof statusMsg.innerHTML==='function')statusMsg.innerHTML('‚úÖ Successfully');}else{if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #ED4245;">‚ùå Error: '+resp.status+'</span>';}} ,onerror:function(){if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #ED4245;">‚ùå Failed to send. Check your webhook URL.</span>';}});}else{fetch(webhook,{method:'POST',headers:{'Content-Type':'application/json'},body:payload}).then(function(r){if(r.status===204){if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #57F287;">‚úÖ Successfully sent to Discord!</span>';}else{if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #ED4245;">‚ùå Error: '+r.status+'</span>';}}).catch(function(err){if(statusMsg&&statusMsg.innerHTML!==undefined)statusMsg.innerHTML='<span style="color: #ED4245;">‚ùå Failed to send. Check your webhook URL.</span>';console.error('Error:',err);});}}
function g(){const en=localStorage.getItem('tw_auto_send_enabled')==='true';const tim=localStorage.getItem('tw_auto_send_time')||'23:00';const webhook=localStorage.getItem('tw_discord_webhook');if(!en||!webhook)return;const tabId=`tab_${Date.now()}_${Math.random().toString(36).substr(2,9)}`;let abort=false;window.addEventListener('storage',function(e){if(e.key==='tw_daily_sent_marker'||e.key==='tw_daily_sending_marker'||e.key==='tw_daily_intent_marker')abort=true;});const check=async function(){abort=false;const now=new Date();const cur=`${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;const today=now.toDateString();const todayKey=`${today}_${tim}`;if(cur!==tim)return;const sent='tw_daily_sent_marker',sending='tw_daily_sending_marker',intent='tw_daily_intent_marker';if(localStorage.getItem(sent)===todayKey)return;const existing=localStorage.getItem(intent);if(existing){try{const obj=JSON.parse(existing);if(obj.key===todayKey&&(Date.now()-obj.timestamp)<10000)return;}catch(e){} }const sendMark=localStorage.getItem(sending);if(sendMark){try{const obj=JSON.parse(sendMark);if(obj.key===todayKey&&(Date.now()-obj.timestamp)<60000)return;}catch(e){} }const myNonce=Date.now()+Math.random();const intentMarker={key:todayKey,tabId:tabId,nonce:myNonce,timestamp:Date.now()};localStorage.setItem(intent,JSON.stringify(intentMarker));await new Promise(function(r){setTimeout(r,50);});if(abort)return;const currentIntent=localStorage.getItem(intent);if(!currentIntent)return;try{const obj=JSON.parse(currentIntent);if(obj.nonce!==myNonce)return;}catch(e){return;}if(localStorage.getItem(sent)===todayKey){localStorage.removeItem(intent);return;}const microDelay=Math.floor(Math.random()*300);await new Promise(function(r){setTimeout(r,microDelay);});if(abort){localStorage.removeItem(intent);return;}if(localStorage.getItem(sent)===todayKey){localStorage.removeItem(intent);return;}const claimMarker={key:todayKey,tabId:tabId,nonce:myNonce,timestamp:Date.now()};localStorage.setItem(sending,JSON.stringify(claimMarker));await new Promise(function(r){setTimeout(r,100);});if(abort){localStorage.removeItem(intent);localStorage.removeItem(sending);return;}const currentClaim=localStorage.getItem(sending);if(!currentClaim){localStorage.removeItem(intent);return;}try{const obj=JSON.parse(currentClaim);if(obj.nonce!==myNonce){localStorage.removeItem(intent);return;}}catch(e){localStorage.removeItem(intent);return;}if(localStorage.getItem(sent)===todayKey){localStorage.removeItem(intent);localStorage.removeItem(sending);return;}localStorage.setItem(sent,todayKey);localStorage.setItem('tw_last_auto_send',today);localStorage.setItem('tw_last_auto_send_time',tim);try{const stats=await c();if(abort)return;if(stats.playerName==='Unknown'||!stats.playerName){const h=webhook.split('/').pop();const key=`tw_player_name_${stats.world}_${h}`;const saved=localStorage.getItem(key);if(saved)stats.playerName=saved;}await hSend(webhook,stats);}catch(err){console.error('Auto-send error:',err);localStorage.removeItem(sent);localStorage.removeItem('tw_last_auto_send');localStorage.removeItem('tw_last_auto_send_time');}finally{try{const curS=localStorage.getItem(sending);if(curS){const o=JSON.parse(curS);if(o.nonce===myNonce)localStorage.removeItem(sending);}const curI=localStorage.getItem(intent);if(curI){const o=JSON.parse(curI);if(o.nonce===myNonce)localStorage.removeItem(intent);} }catch(e){} }};const now=new Date();const minutes=now.getMinutes();const seconds=now.getSeconds();const milliseconds=now.getMilliseconds();const nextInterval=Math.ceil(minutes/10)*10;const minutesUntilNext=(nextInterval-minutes)%60;const msUntil=(minutesUntilNext*60-seconds)*1000-milliseconds;setTimeout(function(){check();setInterval(check,600000);},msUntil);}
async function hSend(webhook,stats){return new Promise(function(resolve,reject){let resolved=false;const timeoutId=setTimeout(function(){if(!resolved){resolved=true;reject(new Error('Discord send timeout after 30 seconds'));}},30000);f(webhook,stats,{innerHTML:function(msg){if(resolved)return;if(msg.includes('Successfully')){resolved=true;clearTimeout(timeoutId);resolve();}else if(msg.includes('Error')||msg.includes('Failed')){resolved=true;clearTimeout(timeoutId);reject(new Error(msg));}}});});}
/* Initialize */
if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',function(){a();g();});}else{a();g();}
})();
