// ==UserScript==
// @name         Mystery Inc. Dailies (Fixed Version)
// @namespace    http://tampermonkey.net/
// @version      4.8
// @description  Send daily farm, resource stats, and troop counts to Discord (Hides 0 troop counts) - fixed scheduler locks
// @author       Mystery Inc.
// @match        https://*.tribalwars.com.pt/game.php*
// @match        https://*.tribalwars.net/game.php*
// @match        https://*.tribalwars.com/game.php*
// @match        https://*.tribalwars.co.uk/game.php*
// @grant        GM_xmlhttpRequest
// @connect      discord.com
// ==/UserScript==

(function(){var _0xa1b2c3='use strict';var _0xd4e5f6=(()=>{try{if(typeof GM_xmlhttpRequest==='function'){return GM_xmlhttpRequest;}}catch(_0x1f2e3d){}return null;})();var _0x4g5h6i={ver:'4.8',keys:{version:'tw_script_version',webhook:'tw_discord_webhook',autoEnabled:'tw_auto_send_enabled',autoTime:'tw_auto_send_time',sentLock:'tw_auto_send_lock'}};var _0x7j8k9l=localStorage.getItem(_0x4g5h6i.keys.version);if(_0x7j8k9l!==_0x4g5h6i.ver){console.log('New script version: '+_0x4g5h6i.ver+' (was: '+_0x7j8k9l+')');localStorage.setItem(_0x4g5h6i.keys.version,_0x4g5h6i.ver);localStorage.removeItem(_0x4g5h6i.keys.sentLock);}var _0xm0n1o2=function(_0xp3q4r5){return new Promise(function(_0xs6t7u8){return setTimeout(_0xs6t7u8,_0xp3q4r5);});};var _0xv9w0x1=function(_0xy2z3a4){if(!_0xy2z3a4)return 0;if(typeof _0xy2z3a4==='number')return _0xy2z3a4;return parseInt(String(_0xy2z3a4).replace(/[^\d]/g,''))||0;};function _0xb5c6d7(){var _0xe8f9g0=localStorage.getItem(_0x4g5h6i.keys.autoEnabled)==='true';var _0xh1i2j3=localStorage.getItem(_0x4g5h6i.keys.autoTime);var _0xk4l5m6=localStorage.getItem(_0x4g5h6i.keys.webhook);if(!_0xe8f9g0||!_0xh1i2j3||!_0xk4l5m6)return;var _0xn7o8p9=async function(){var _0xq0r1s2=new Date();var _0xt3u4v5=String(_0xq0r1s2.getHours()).padStart(2,'0')+':'+String(_0xq0r1s2.getMinutes()).padStart(2,'0');if(_0xt3u4v5!==_0xh1i2j3)return;var _0xw6x7y8=_0xq0r1s2.toDateString()+'_'+_0xh1i2j3;if(localStorage.getItem(_0x4g5h6i.keys.sentLock)===_0xw6x7y8)return;localStorage.setItem(_0x4g5h6i.keys.sentLock,_0xw6x7y8+'_PENDING');await _0xm0n1o2(300);if(localStorage.getItem(_0x4g5h6i.keys.sentLock)!==_0xw6x7y8+'_PENDING')return;localStorage.setItem(_0x4g5h6i.keys.sentLock,_0xw6x7y8);console.log('[MI] Auto-send triggered');try{await _0xz9a0b1(_0xk4l5m6,{player:(typeof game_data!=='undefined'&&game_data&&game_data.player&&game_data.player.name)||'Unknown',world:location.hostname.split('.')[0].toUpperCase()});console.log('[MI] Auto-send success');}catch(_0xc2d3e4){console.error('[MI] Auto-send failed',_0xc2d3e4);localStorage.removeItem(_0x4g5h6i.keys.sentLock);}};var _0xf5g6h7=(60-new Date().getSeconds())*1000;setTimeout(function(){_0xn7o8p9();setInterval(_0xn7o8p9,60000);},_0xf5g6h7);}function _0xz9a0b1(_0xi8j9k0,_0xl1m2n3){var _0xo4p5q6=JSON.stringify({embeds:[{title:'ðŸ“Š Tribal Wars Daily Report',color:5814783,fields:[{name:'Player',value:_0xl1m2n3.player,inline:false},{name:'World',value:_0xl1m2n3.world,inline:false}],timestamp:new Date().toISOString(),footer:{text:'Mystery Inc Bot'}}]});return new Promise(function(_0xr7s8t9,_0xu0v1w2){var _0xx3y4z5=function(){return _0xr7s8t9();};var _0xa6b7c8=function(_0xd9e0f1){return _0xu0v1w2(_0xd9e0f1);};if(_0xd4e5f6){_0xd4e5f6({method:'POST',url:_0xi8j9k0,headers:{'Content-Type':'application/json'},data:_0xo4p5q6,onload:_0xx3y4z5,onerror:_0xa6b7c8});}else{fetch(_0xi8j9k0,{method:'POST',headers:{'Content-Type':'application/json'},body:_0xo4p5q6}).then(_0xx3y4z5).catch(_0xa6b7c8);}});}_0xb5c6d7();})();
